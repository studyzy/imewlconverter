# 构建系统规范增量

## 新增需求

### 需求：自动化版本号生成
系统必须在构建时自动从 Git 仓库的 tag 提取版本号，并将其注入到所有生成的二进制文件中，而不是依赖硬编码的版本号。

#### 场景：从 Git tag 构建正式 Release
- **当** 开发者创建符合 `vX.Y.Z` 格式的 Git tag（如 `v3.4.0`）
- **并且** 推送该 tag 到远程仓库
- **那么** GitHub Actions 自动触发 Release 构建
- **并且** 所有生成的二进制文件（Windows、Linux、macOS）的版本号为 `3.4.0.0`
- **并且** 程序运行时显示的版本号为 `3.4.0.0`

#### 场景：本地开发构建（有 Git tag）
- **当** 开发者在本地克隆的 Git 仓库中执行构建命令
- **并且** 当前 commit 有对应的 tag（如 `v3.4.0`）
- **那么** 构建生成的二进制文件版本号为 `3.4.0.0`

#### 场景：本地开发构建（无 Git tag）
- **当** 开发者在本地克隆的 Git 仓库中执行构建命令
- **并且** 当前 commit 没有对应的 tag
- **那么** 构建生成的二进制文件版本号为 `0.0.0-dev.{commits}.{sha}`
- **并且** 构建不会失败，可以正常运行和调试

#### 场景：CI 构建非 tag commit
- **当** 开发者推送 commit 到远程仓库（非 tag）
- **那么** GitHub Actions 触发 CI 构建
- **并且** 所有生成的二进制文件版本号为开发版本格式（如 `0.0.0-dev.42.abc1234`）
- **并且** 构建不会失败

#### 场景：版本号在程序中可访问
- **当** 程序代码需要获取当前版本号
- **那么** 可以通过 `ConstantString.VERSION` 常量访问版本号
- **并且** 该版本号与程序集元数据中的版本号一致
- **并且** 版本号格式为 `X.Y.Z.W` 或 `X.Y.Z.W-prerelease`

### 需求：统一的版本号配置
系统必须使用单一的版本号配置机制，避免在多个文件中重复定义版本号。

#### 场景：全局版本号配置
- **当** 项目需要配置版本号生成规则
- **那么** 配置必须集中在 `Directory.Build.props` 文件中
- **并且** 所有子项目自动继承该配置
- **并且** 不需要在每个 `.csproj` 文件中重复配置版本号

#### 场景：移除硬编码版本号
- **当** 开发者查看源代码
- **那么** 不应在以下位置找到硬编码的版本号字符串：
  - `ConstantString.cs` 的 `VERSION` 常量（应从程序集属性读取）
  - 任何 `.csproj` 文件的 `<Version>` 标签（应由构建工具自动生成）
- **但是** 允许在文档和注释中包含示例版本号

### 需求：版本号格式规范
系统必须遵循统一的版本号格式规范，确保版本号的可读性和一致性。

#### 场景：Git tag 格式验证
- **当** 开发者创建 Git tag 用于发布
- **那么** tag 名称必须符合格式 `vX.Y.Z`，其中 X、Y、Z 为非负整数
- **并且** 可选支持预发布标识符，如 `vX.Y.Z-beta.1`、`vX.Y.Z-rc.2`
- **并且** 如果 tag 格式不正确，Release 构建必须失败并提示错误

#### 场景：程序集版本号格式
- **当** 构建生成二进制文件
- **那么** 程序集版本号格式为 `X.Y.Z.0`（正式版本）或 `X.Y.Z.0-prerelease`（预发布版本）
- **并且** 文件版本号格式与程序集版本号相同
- **并且** 信息版本号可包含额外的元数据（如 commit SHA）

#### 场景：开发版本号格式
- **当** 构建不是从 Git tag 触发
- **那么** 版本号格式为 `0.0.0-dev.{commits}.{sha}`
- **并且** `{commits}` 为从最近 tag 到当前 commit 的提交数
- **并且** `{sha}` 为当前 commit 的短 SHA（7 位）

### 需求：多平台版本号一致性
系统必须确保所有平台的二进制文件使用相同的版本号生成机制和格式。

#### 场景：跨平台版本号验证
- **当** 从同一个 Git tag 构建所有平台的二进制文件
- **那么** 以下平台的版本号必须完全一致：
  - Windows x86 CLI
  - Windows x64 CLI
  - Windows x86 GUI
  - Windows x64 GUI
  - Linux x64 CLI
  - Linux ARM64 CLI
  - macOS x64 CLI
  - macOS ARM64 CLI
  - macOS x64 GUI
  - macOS ARM64 GUI
- **并且** 所有二进制文件运行 `--version` 或在"关于"对话框中显示的版本号相同

#### 场景：macOS 应用包版本号
- **当** 构建 macOS 应用包（.app）
- **那么** `Info.plist` 中的 `CFBundleVersion` 和 `CFBundleShortVersionString` 必须与程序集版本号一致
- **并且** 在 macOS Finder 中查看应用信息时，显示的版本号正确

### 需求：构建环境容错性
系统必须在各种构建环境中都能可靠工作，包括 CI/CD 环境和本地开发环境。

#### 场景：完整 Git history 可用
- **当** 在 GitHub Actions 中执行构建
- **那么** 必须使用 `actions/checkout@v4` 并设置 `fetch-depth: 0`
- **并且** 必须获取所有 Git tags
- **并且** 版本号工具能够访问完整的 Git 历史和 tag 信息

#### 场景：Git 不可用时的后备机制
- **当** 在非 Git 环境中执行构建（如从源码包构建）
- **那么** 构建不应失败
- **并且** 使用默认版本号 `0.0.0` 或在 `.csproj` 中预设的后备版本号
- **并且** 在构建日志中记录警告信息

#### 场景：浅克隆场景处理
- **当** Git 仓库是浅克隆（shallow clone）
- **并且** 没有包含版本 tag
- **那么** 构建不应失败
- **并且** 使用开发版本号格式
- **并且** 在构建日志中记录警告信息

### 需求：版本号验证和日志
系统必须在构建过程中验证版本号的正确性，并提供清晰的日志输出。

#### 场景：构建时显示版本号
- **当** 执行构建命令
- **那么** 在构建日志中输出当前使用的版本号
- **并且** 输出格式为：`Building version: X.Y.Z.W` 或 `Building version: X.Y.Z.W-prerelease`
- **并且** 如果版本号来自 Git tag，输出 tag 名称

#### 场景：版本号冲突检测
- **当** Git 仓库中存在多个 tag 指向同一个 commit
- **那么** 版本号工具选择语义化版本最高的 tag
- **并且** 在构建日志中记录所有候选 tag

#### 场景：无效 tag 警告
- **当** Git 仓库中存在不符合 `vX.Y.Z` 格式的 tag
- **那么** 版本号工具忽略这些无效 tag
- **并且** 在构建日志中记录警告信息
- **但是** 构建不应失败

## 修改需求
（无）

## 移除需求
（无）

## 重命名需求
（无）
