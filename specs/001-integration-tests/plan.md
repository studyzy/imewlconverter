# 实施计划: 词库转换集成测试框架

**分支**: `001-integration-tests` | **日期**: 2026-01-25 | **规范**: [spec.md](./spec.md)
**输入**: 来自 `/specs/001-integration-tests/spec.md` 的功能规范

**注意**: 此模板由 `/speckit.plan` 命令填充. 执行工作流程请参见 `.specify/templates/commands/plan.md`.

## 摘要

本功能为深蓝词库转换项目建立自动化集成测试框架，通过命令行工具调用词库转换器并验证输出结果的正确性。主要目标：

1. **基础框架（P1）**：建立Shell脚本驱动的测试运行器，支持批量执行测试用例，生成易读的测试报告
2. **多格式覆盖（P2）**：为至少5种主要输入法格式（搜狗拼音、QQ拼音、百度拼音、搜狗五笔、QQ五笔）创建标准测试数据集
3. **CI集成（P3）**：集成到GitHub Actions工作流，实现每次代码提交后自动运行测试

**技术方案**：采用Shell脚本（Bash/Zsh）作为测试驱动器，利用现有的`ImeWlConverterCmd`命令行工具执行转换，使用`diff`等标准Unix工具进行结果验证。这种轻量级方案无需额外的编程语言依赖，易于维护和理解。

## 技术背景

**语言/版本**: Bash 4.0+ / Zsh 5.0+ (脚本语言), 依赖现有的.NET CLI工具
**主要依赖**: 
  - `ImeWlConverterCmd`: 现有的C#命令行转换工具
  - `diff`: 文本比较工具（系统自带）
  - `jq`: JSON处理工具（可选，用于生成结构化报告）
  - 标准Unix工具: `find`, `grep`, `awk`, `sed`

**存储**: 文件系统
  - 测试数据: `tests/integration/test-data/`
  - 测试输出: `tests/integration/test-output/` (临时目录)
  - 测试报告: `tests/integration/reports/`

**测试框架**: 自定义Shell脚本框架
  - 测试运行器: `tests/integration/run-tests.sh`
  - 辅助函数: `tests/integration/lib/test-helpers.sh`
  - 测试用例: YAML配置文件 + 数据文件

**目标平台**: 
  - Linux (Ubuntu 20.04+, CentOS 8+)
  - macOS (10.15+)
  - Windows (通过Git Bash或WSL)

**项目类型**: 单一项目 - 测试工具独立于主代码库

**性能目标**:
  - 单个测试执行时间: <10秒（文件<1MB）
  - 完整测试套件: <3分钟（20+测试用例）
  - CI总运行时间: <5分钟（包括构建和测试）

**约束条件**:
  - 必须跨平台兼容（Windows、Linux、macOS）
  - 必须易于添加新测试用例（<10分钟）
  - 测试失败时必须提供清晰的差异报告
  - 不引入新的编程语言依赖（避免C#、Python等额外依赖）

**规模/范围**:
  - 初期覆盖5种输入法格式
  - 每种格式至少4个测试用例（正常、边界、错误、编码）
  - 总计20+测试用例
  - 后续可扩展至覆盖全部20+种格式

## 章程检查

*门控: 必须在阶段 0 研究前通过. 阶段 1 设计后重新检查. *

### 测试要求
- [x] **是否为每个功能定义了集成测试场景？** 是 - 本身就是集成测试功能，在spec.md中定义了3个用户故事的验收场景
- [x] **预计单元测试覆盖率能否达到60%以上？** 部分适用 - Shell脚本可以通过`shunit2`等工具进行单元测试，辅助函数库将达到60%+覆盖率
- [x] **是否计划遵循TDD工作流（测试先行）？** 是 - 先创建测试用例配置和预期输出，再编写测试执行逻辑

### 文档与注释
- [x] **是否计划为所有公共API添加中文XML注释？** 部分适用 - Shell脚本使用中文注释，所有函数有清晰的文档说明
- [x] **复杂算法是否有中文说明文档？** 是 - 文本比较逻辑、报告生成逻辑都会有中文文档
- [x] **是否更新了README和Wiki文档？** 是 - 将在README中添加"集成测试"章节，详细说明使用方法

### 代码规范
- [x] **是否遵循Microsoft C#编码规范？** 不适用 - 使用Shell脚本，遵循Shell脚本最佳实践（Google Shell Style Guide）
- [x] **命名是否符合PascalCase/camelCase约定？** 部分适用 - Shell函数使用snake_case，变量使用大写下划线（UPPER_SNAKE_CASE）
- [x] **方法复杂度是否控制在合理范围（<50行，<10圈复杂度）？** 是 - 每个Shell函数<50行，复杂逻辑拆分为多个小函数

### 跨平台兼容性
- [x] **核心库是否支持.NET 8.0和.NET Framework 4.6？** 是 - 测试框架调用现有的跨平台CLI工具
- [x] **是否避免使用平台特定API（或有抽象层）？** 是 - 使用POSIX标准命令，平台差异通过条件判断处理
- [x] **文件路径和字符编码处理是否正确？** 是 - 使用相对路径，明确指定UTF-8编码

### 版本与发布
- [x] **是否避免手动修改版本号？** 是 - 测试框架无需版本号管理
- [x] **变更是否符合语义化版本规范？** 不适用 - 测试工具不发布独立版本

### 架构原则
- [x] **是否保持核心逻辑与UI分离？** 是 - 测试逻辑（脚本）与被测试对象（CLI工具）完全分离
- [x] **新增转换器是否符合开闭原则？** 是 - 新增测试用例只需添加配置和数据文件，无需修改测试运行器代码
- [x] **是否避免不必要的复杂性（如需豁免需说明理由）？** 是 - 采用最简单的Shell脚本方案，避免引入额外的测试框架

**章程豁免说明**：
本功能使用Shell脚本而非C#，这是一个合理的架构决策：
- **理由**: 集成测试属于黑盒测试，不需要与被测代码使用相同语言。Shell脚本更轻量、更易于CI集成
- **对比**: 如果用C#编写，需要额外的测试项目、NuGet依赖、编译步骤；Shell脚本直接运行，维护成本更低
- **风险**: 无风险，测试脚本独立于核心代码库，不影响现有C#代码的质量和结构

## 项目结构

### 文档(此功能)

```
specs/001-integration-tests/
├── plan.md              # 此文件 (/speckit.plan 命令输出)
├── research.md          # 阶段 0 输出 - 技术选型研究
├── data-model.md        # 阶段 1 输出 - 测试数据结构
├── quickstart.md        # 阶段 1 输出 - 5分钟快速开始
└── contracts/           # 阶段 1 输出 - 测试配置格式规范
    └── test-case-schema.yaml  # 测试用例配置格式
```

### 源代码(仓库根目录)

```
tests/
└── integration/
    ├── run-tests.sh              # 主测试运行器脚本（入口点）
    ├── lib/
    │   ├── test-helpers.sh       # 辅助函数库（执行测试、比较结果）
    │   ├── report-generator.sh   # 报告生成函数
    │   └── color-output.sh       # 彩色终端输出
    ├── test-cases/
    │   ├── sougou-pinyin/        # 搜狗拼音测试用例
    │   │   ├── test-config.yaml  # 测试配置
    │   │   ├── basic.txt         # 输入文件
    │   │   ├── basic.expected    # 预期输出
    │   │   ├── boundary.txt      
    │   │   ├── boundary.expected
    │   │   └── README.md         # 测试说明
    │   ├── qq-pinyin/            # QQ拼音测试用例
    │   ├── baidu-pinyin/         # 百度拼音测试用例
    │   ├── sougou-wubi/          # 搜狗五笔测试用例
    │   └── qq-wubi/              # QQ五笔测试用例
    ├── test-output/              # 临时输出目录（.gitignore）
    ├── reports/                  # 测试报告目录
    │   └── .gitkeep
    ├── README.md                 # 集成测试使用指南
    └── .github/
        └── workflows/
            └── integration-tests.yml  # GitHub Actions工作流
```

**结构决策**:
- **选择Shell脚本而非C#测试项目**: 降低复杂度，避免编译步骤，更易于CI集成
- **测试数据按格式组织**: 每种输入法格式独立目录，便于扩展和维护
- **YAML配置格式**: 人类可读，易于编辑，支持复杂的测试场景配置
- **独立的lib/目录**: 将可重用的函数提取出来，提高代码复用性和可测试性

## 复杂度跟踪

*本功能未违反章程原则，无需复杂性豁免*

所有设计决策都符合"简单性优先"原则：
- ✅ 使用标准Unix工具，无额外依赖
- ✅ 采用文件系统存储，无需数据库
- ✅ 配置即代码（YAML），无需复杂的API
- ✅ 测试用例可独立添加，符合开闭原则
