# 功能规范: 词库转换集成测试框架

**功能分支**: `001-integration-tests`
**创建时间**: 2026-01-25
**状态**: 草稿
**输入**: 用户描述: "这是已经开源多年的深蓝词库转换，但是当年代码比较生疏，有不少Bug，我希望增加一个集成测试功能，通过命令行下去调用词库转换，然后验证各种词库的转换模式下，转换的结果是否正确。"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 基础集成测试框架 (优先级: P1)

作为开发者，我希望能够通过命令行自动运行词库转换测试，验证基本的转换场景是否正确工作，这样可以快速发现代码变更引入的Bug。

**优先级原因**: 这是整个测试系统的基础，必须首先建立。能够自动化测试最常用的转换场景（如搜狗拼音→QQ拼音），可以立即提供价值，防止回归问题。

**独立测试**: 可以通过准备一个简单的搜狗拼音测试词库文件，运行集成测试命令，验证是否能成功转换并检查输出结果是否符合预期。

**验收场景**: 

1. **给定** 一个包含已知词条的搜狗拼音测试词库文件，**当** 开发者运行集成测试命令将其转换为QQ拼音格式时，**那么** 系统应该成功完成转换，并且输出文件中的词条与预期结果完全一致
2. **给定** 一个格式错误的测试词库文件，**当** 开发者运行集成测试时，**那么** 系统应该检测到错误并报告详细的错误信息，测试标记为失败
3. **给定** 多个测试词库文件，**当** 开发者运行批量集成测试时，**那么** 系统应该逐个测试并生成完整的测试报告，显示通过和失败的数量

---

### 用户故事 2 - 多格式转换覆盖 (优先级: P2)

作为质量保证人员，我希望能够测试所有支持的输入法格式之间的转换，确保每种转换模式都能正确处理各种词库特性（拼音、五笔、注音等）。

**优先级原因**: 项目支持20+种输入法格式，全面的格式覆盖测试能够确保代码质量，减少用户报告的Bug。这是在基础框架上的扩展。

**独立测试**: 可以通过为每种主要输入法格式准备测试数据集，运行完整的测试套件，验证所有转换路径是否都能正确工作。

**验收场景**: 

1. **给定** 各种输入法格式的标准测试词库（搜狗、QQ、百度、谷歌等），**当** 运行完整测试套件时，**那么** 每种格式到其他格式的转换都应该通过测试，正确处理特殊字符、编码和格式特性
2. **给定** 包含边界情况的测试词库（超长词条、特殊符号、生僻字），**当** 运行测试时，**那么** 系统应该正确处理这些情况或提供明确的错误提示
3. **给定** 不同编码的测试文件（UTF-8、GBK），**当** 运行跨平台测试时，**那么** 所有平台上的转换结果应该一致

---

### 用户故事 3 - 回归测试与持续集成 (优先级: P3)

作为项目维护者，我希望集成测试能够在每次代码提交时自动运行，确保新的代码变更不会破坏现有功能，并生成详细的测试报告。

**优先级原因**: 自动化CI集成是长期代码质量保证的关键，但可以在手动测试框架稳定后再实施。

**独立测试**: 可以通过在CI环境中配置测试任务，提交一个测试性代码变更，验证测试是否自动运行并正确报告结果。

**验收场景**: 

1. **给定** 一个新的代码提交，**当** CI系统检测到变更时，**那么** 应该自动运行完整的集成测试套件并在拉取请求中显示结果
2. **给定** 测试失败的情况，**当** 开发者查看CI报告时，**那么** 应该能够清楚地看到哪些测试失败、失败原因以及期望值与实际值的差异
3. **给定** 测试运行历史数据，**当** 项目维护者查看测试趋势时，**那么** 应该能够看到测试通过率的变化、新增的测试用例数量等指标

---

### 边界情况

- **空文件处理**: 当测试词库文件为空时，系统应该识别并报告，而不是崩溃
- **超大文件**: 当词库文件非常大（如>100MB）时，测试应该能够在合理时间内完成或提供超时提示
- **文件编码问题**: 当词库文件编码与声明不符时，系统应该检测并报告编码错误
- **格式版本差异**: 当输入法格式有多个版本（如搜狗早期版本vs新版本）时，测试应该能够区分并正确处理
- **权限问题**: 当测试在没有文件写入权限的目录运行时，应该提供清晰的错误信息
- **并发测试**: 当多个测试同时运行时，不应该出现文件冲突或竞态条件
- **命令行参数错误**: 当用户提供错误的命令行参数时，应该显示清晰的使用帮助信息

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须能够通过命令行接受测试词库文件路径、源格式、目标格式作为输入参数
- **FR-002**: 系统必须执行词库转换并将结果与预期输出文件进行比较
- **FR-003**: 系统必须能够检测转换结果中的差异（词条缺失、多余、内容不匹配）
- **FR-004**: 系统必须生成易读的测试报告，包括通过/失败的测试数量、失败详情、执行时间
- **FR-005**: 系统必须支持批量运行多个测试用例，每个测试用例包含输入文件、转换配置、预期输出
- **FR-006**: 系统必须能够为每种主要输入法格式提供标准测试数据集
- **FR-007**: 系统必须在测试失败时提供详细的差异对比信息（期望值vs实际值）
- **FR-008**: 系统必须支持不同的测试模式：单个测试、分类测试（按格式）、完整测试套件
- **FR-009**: 系统必须能够验证转换后文件的完整性（非空、格式正确、编码正确）
- **FR-010**: 系统必须记录测试执行日志，包括每个测试的开始时间、结束时间、结果状态

### 测试需求 (符合章程原则I)

- **TR-001**: 集成测试框架本身必须有单元测试覆盖核心功能（如文件比较逻辑、报告生成）
- **TR-002**: 必须为至少5种主要输入法格式创建测试用例（搜狗拼音、QQ拼音、百度拼音、搜狗五笔、QQ五笔）
- **TR-003**: 每个测试用例必须包含正常场景、边界情况、错误处理场景
- **TR-004**: 测试框架的单元测试覆盖率必须达到60%以上

### 文档需求 (符合章程原则II)

- **DR-001**: 必须提供集成测试使用指南，包括如何运行测试、如何添加新测试用例、如何解读测试报告
- **DR-002**: 所有测试相关的公共类和方法必须有中文XML文档注释
- **DR-003**: 必须在README中添加集成测试相关章节，说明测试覆盖范围和运行方法
- **DR-004**: 每个测试数据集必须有说明文档，解释测试目的和预期行为

### 跨平台需求 (符合章程原则IV)

- **PR-001**: 集成测试必须能够在Windows、Linux、macOS上正常运行
- **PR-002**: 测试脚本必须支持.NET 8.0和.NET Framework 4.6
- **PR-003**: 测试数据文件路径处理必须使用跨平台兼容的方式
- **PR-004**: 测试结果报告必须使用统一的换行符和编码格式

### 关键实体

- **TestCase（测试用例）**: 代表一个独立的转换测试，包含输入文件路径、源格式、目标格式、预期输出文件路径、测试名称、测试描述
- **TestResult（测试结果）**: 代表一个测试用例的执行结果，包含测试名称、是否通过、执行时间、错误信息、差异详情
- **TestSuite（测试套件）**: 代表一组相关的测试用例集合，包含测试套件名称、包含的测试用例列表、整体通过率
- **TestReport（测试报告）**: 代表完整的测试执行报告，包含所有测试结果、统计信息（总数、通过数、失败数）、执行总时间、生成时间

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 开发者可以在5分钟内完成集成测试框架的设置并运行第一个测试用例
- **SC-002**: 单个词库转换测试（文件<1MB）的执行时间不超过10秒
- **SC-003**: 完整测试套件（覆盖至少5种输入法格式、20个测试用例）能在3分钟内完成
- **SC-004**: 测试框架能够检测并报告至少95%的已知转换Bug
- **SC-005**: 测试失败时，错误报告必须清楚地指出具体哪个词条、哪个字段出现差异，开发者无需额外调试工具就能定位问题
- **SC-006**: 新的测试用例添加过程不超过10分钟（准备测试数据+配置测试用例）
- **SC-007**: 测试报告必须以易读的格式（如表格、彩色输出）展示，任何人都能快速理解测试状态
- **SC-008**: 集成测试在CI环境中的失败率不超过1%（排除真实Bug导致的失败）

## 假设

- 假设项目已有命令行工具可以执行词库转换（ImeWlConverterCmd）
- 假设测试数据集可以存放在项目的test-data目录中
- 假设开发者熟悉基本的命令行操作
- 假设CI环境为GitHub Actions或类似的持续集成系统
- 假设测试框架使用C#编写，与现有项目代码库语言一致
- 假设测试报告可以输出为控制台文本格式和JUnit XML格式（用于CI集成）
